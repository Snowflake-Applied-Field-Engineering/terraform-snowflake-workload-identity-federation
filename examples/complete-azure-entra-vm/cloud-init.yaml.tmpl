#cloud-config
# Cloud-init configuration for Azure VM
# Sets up Python environment and Snowflake WIF test script

package_update: true
package_upgrade: true

packages:
  - python3
  - python3-pip
  - python3-venv
  - jq
  - git
  - ca-certificates
  - curl

write_files:
  - path: /opt/snowflake-test/test_snowflake.py
    permissions: '0755'
    content: |
${indent(6, test_script)}

  - path: /etc/profile.d/snowflake-test.sh
    permissions: '0644'
    content: |
      export SNOWFLAKE_DEFAULT_AUTHENTICATOR="${snowflake_default_authenticator}"
      export SNOWFLAKE_ACCOUNT="${snowflake_default_account}"
      export AZURE_TENANT_ID="${azure_tenant_id}"

runcmd:
  # Create application directory
  - mkdir -p /opt/snowflake-test
  - chmod 755 /opt/snowflake-test

  # Verify Python version (>= 3.9)
  - python3 --version

  # Create and activate virtual environment
  - python3 -m venv /opt/snowflake-test/venv
  - /opt/snowflake-test/venv/bin/pip install --upgrade pip

  # Install Snowflake connector and Azure identity library
  - /opt/snowflake-test/venv/bin/pip install "snowflake-connector-python>=3.17"
  - /opt/snowflake-test/venv/bin/pip install "azure-identity>=1.15.0"

  # Set proper permissions
  - chmod 755 /opt/snowflake-test/test_snowflake.py
  - chown -R root:root /opt/snowflake-test

  # Create a convenience script to run the test
  - |
    cat > /usr/local/bin/test-snowflake-wif <<'EOF'
    #!/bin/bash
    source /opt/snowflake-test/venv/bin/activate
    python3 /opt/snowflake-test/test_snowflake.py
    EOF
  - chmod 755 /usr/local/bin/test-snowflake-wif

  # Log completion
  - echo "Snowflake WIF test environment setup complete" | tee -a /var/log/cloud-init-output.log
  - echo "Run test with: test-snowflake-wif" | tee -a /var/log/cloud-init-output.log
  - echo "Or: source /opt/snowflake-test/venv/bin/activate && python3 /opt/snowflake-test/test_snowflake.py" | tee -a /var/log/cloud-init-output.log

final_message: |
  ========================================
  Snowflake WIF Test Environment Ready
  ========================================

  To test the WIF connection:
  1. sudo su -
  2. test-snowflake-wif

  Or manually:
  1. source /opt/snowflake-test/venv/bin/activate
  2. python3 /opt/snowflake-test/test_snowflake.py

  Configuration:
  - Snowflake Account: ${snowflake_default_account}
  - Authenticator: ${snowflake_default_authenticator}
  - Azure Tenant ID: ${azure_tenant_id}

  ========================================
