#cloud-config
# Cloud-init configuration for Azure VM
# Sets up Python environment and Snowflake WIF test script

package_update: true
package_upgrade: true

packages:
  - python3
  - python3-pip
  - python3-venv
  - jq
  - git
  - ca-certificates
  - curl

write_files:
  - path: /opt/snowflake-test/cloud-init-still-running.txt
    permissions: '0755'
    content: |
      Cloud-init is still running. Please wait...
  - path: /opt/snowflake-test/test_snowflake.py
    permissions: '0755'
    content: |
      ${indent(6, test_script)}

  - path: /usr/local/bin/test-snowflake-wif
    permissions: '0755'
    content: |
      #!/bin/bash
      # export SNOWFLAKE_DEFAULT_AUTHENTICATOR="${snowflake_default_authenticator}"
      # export SNOWFLAKE_ACCOUNT="${snowflake_default_account}"
      # export AZURE_TENANT_ID="${azure_tenant_id}"
      source /opt/snowflake-test/venv/bin/activate
      python3 /opt/snowflake-test/test_snowflake.py

runcmd:
  # Create and activate virtual environment
  - python3 -m venv /opt/snowflake-test/venv
  - /opt/snowflake-test/venv/bin/pip install --upgrade pip

  # Install Snowflake connector and Azure identity library
  - /opt/snowflake-test/venv/bin/pip install "snowflake-connector-python>=3.17"
  - /opt/snowflake-test/venv/bin/pip install "azure-identity>=1.15.0"

  # Fix permissions
  - chown -R 1000:1000 /opt/snowflake-test

  # Remove the cloud-init-still-running.txt file to indicate that cloud-init has finished
  - rm /opt/snowflake-test/cloud-init-still-running.txt

final_message: |
  ========================================
  Snowflake WIF Test Environment Ready
  ========================================

  To test the WIF connection:
  1. test-snowflake-wif

  Or manually:
  1. source /opt/snowflake-test/venv/bin/activate
  2. python3 /opt/snowflake-test/test_snowflake.py

  Configuration:
  - Snowflake Account: ${snowflake_default_account}
  - Authenticator: ${snowflake_default_authenticator}
  - Azure Tenant ID: ${azure_tenant_id}

  ========================================
